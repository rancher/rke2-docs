"use strict";(self.webpackChunkrke_2_docs=self.webpackChunkrke_2_docs||[]).push([[3268],{9096:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>o,default:()=>h,frontMatter:()=>i,metadata:()=>a,toc:()=>l});var r=s(5893),t=s(1151);const i={title:"High Availability"},o=void 0,a={id:"install/ha",title:"High Availability",description:"This section describes how to install a high availability (HA) RKE2 cluster. An HA RKE2 cluster consists of:",source:"@site/docs/install/ha.md",sourceDirName:"install",slug:"/install/ha",permalink:"/install/ha",draft:!1,unlisted:!1,editUrl:"https://github.com/rancher/rke2-docs/edit/main/docs/install/ha.md",tags:[],version:"current",lastUpdatedAt:1705430163,formattedLastUpdatedAt:"Jan 16, 2024",frontMatter:{title:"High Availability"},sidebar:"mySidebar",previous:{title:"Network Options",permalink:"/install/network_options"},next:{title:"Installation Methods",permalink:"/install/methods"}},d={},l=[{value:"1. Configure the Fixed Registration Address",id:"1-configure-the-fixed-registration-address",level:3},{value:"2. Launch the first server node",id:"2-launch-the-first-server-node",level:3},{value:"2a. Optional: Consider server node taints",id:"2a-optional-consider-server-node-taints",level:4},{value:"3. Launch additional server nodes",id:"3-launch-additional-server-nodes",level:3},{value:"4. Confirm cluster is functional",id:"4-confirm-cluster-is-functional",level:3},{value:"5. Optional: Join Agent Nodes",id:"5-optional-join-agent-nodes",level:3}];function c(e){const n={a:"a",admonition:"admonition",code:"code",h3:"h3",h4:"h4",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.a)(),...e.components},{Details:i}=n;return i||function(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.p,{children:"This section describes how to install a high availability (HA) RKE2 cluster. An HA RKE2 cluster consists of:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["A ",(0,r.jsx)(n.strong,{children:"fixed registration address"})," that is placed in front of server nodes to allow other nodes to register with the cluster"]}),"\n",(0,r.jsxs)(n.li,{children:["An odd number (three recommended) of ",(0,r.jsx)(n.strong,{children:"server nodes"})," that will run etcd, the Kubernetes API, and other control plane services"]}),"\n",(0,r.jsxs)(n.li,{children:["Zero or more ",(0,r.jsx)(n.strong,{children:"agent nodes"})," that are designated to run your apps and services"]}),"\n"]}),"\n",(0,r.jsxs)(i,{children:[(0,r.jsx)("summary",{children:"Why An Odd Number Of Server Nodes?"}),(0,r.jsx)(n.p,{children:"An etcd cluster must be comprised of an odd number of server nodes for etcd to maintain quorum. For a cluster with n servers, quorum is (n/2)+1. For any odd-sized cluster, adding one node will always increase the number of nodes necessary for quorum. Although adding a node to an odd-sized cluster appears better since there are more machines, the fault tolerance is worse. Exactly the same number of nodes can fail without losing quorum, but there are now more nodes that can fail."})]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"High Availability",src:s(1445).Z+"",width:"993",height:"743"})}),"\n",(0,r.jsxs)(n.p,{children:["Agents register through the fixed registration address. However, when RKE2 launches the kubelet and it must connect to the Kubernetes api-server, it does so through the ",(0,r.jsx)(n.code,{children:"rke2 agent"})," process, which acts as a client-side load balancer."]}),"\n",(0,r.jsx)(n.p,{children:"Setting up an HA cluster requires the following steps:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Configure a fixed registration address"}),"\n",(0,r.jsx)(n.li,{children:"Launch the first server node"}),"\n",(0,r.jsx)(n.li,{children:"Join additional server nodes"}),"\n",(0,r.jsx)(n.li,{children:"Join agent nodes"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"1-configure-the-fixed-registration-address",children:"1. Configure the Fixed Registration Address"}),"\n",(0,r.jsx)(n.p,{children:"Server nodes beyond the first one and all agent nodes need a URL to register against. This can be the IP or hostname of any of the server nodes, but in many cases those may change over time as nodes are created and destroyed. Therefore, you should have a stable endpoint in front of the server nodes."}),"\n",(0,r.jsx)(n.p,{children:"This endpoint can be set up using any number approaches, such as:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"A layer 4 (TCP) load balancer"}),"\n",(0,r.jsx)(n.li,{children:"Round-robin DNS"}),"\n",(0,r.jsx)(n.li,{children:"Virtual or elastic IP addresses"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["This endpoint can also be used for accessing the Kubernetes API. So you can, for example, modify your ",(0,r.jsx)(n.a,{href:"https://kubernetes.io/docs/concepts/configuration/organize-cluster-access-kubeconfig/",children:"kubeconfig"})," file to point to it instead of a specific node."]}),"\n",(0,r.jsxs)(n.p,{children:["Note that the ",(0,r.jsx)(n.code,{children:"rke2 server"})," process listens on port ",(0,r.jsx)(n.code,{children:"9345"})," for new nodes to register. The Kubernetes API is served on port ",(0,r.jsx)(n.code,{children:"6443"}),", as normal. Configure your load balancer accordingly."]}),"\n",(0,r.jsx)(n.h3,{id:"2-launch-the-first-server-node",children:"2. Launch the first server node"}),"\n",(0,r.jsx)(n.p,{children:"The first server node establishes the secret token that other server or agent nodes will register with when connecting to the cluster."}),"\n",(0,r.jsxs)(n.p,{children:["To specify your own pre-shared secret as the token, set the ",(0,r.jsx)(n.code,{children:"token"})," argument on startup."]}),"\n",(0,r.jsxs)(n.p,{children:["If you do not specify a pre-shared secret, RKE2 will generate one and place it at ",(0,r.jsx)(n.code,{children:"/var/lib/rancher/rke2/server/node-token"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:["To avoid certificate errors with the fixed registration address, you should launch the server with the ",(0,r.jsx)(n.code,{children:"tls-san"})," parameter set. This option adds an additional hostname or IP as a Subject Alternative Name in the server's TLS cert, and it can be specified as a list if you would like to access via both the IP and the hostname."]}),"\n",(0,r.jsx)(n.p,{children:"Example of RKE2 config file for first server:"}),"\n",(0,r.jsx)(n.admonition,{type:"note",children:(0,r.jsxs)(n.p,{children:["The RKE2 config file needs to be created manually. You can do that by running ",(0,r.jsx)(n.code,{children:"touch /etc/rancher/rke2/config.yaml"})," as a privileged user."]})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"token: my-shared-secret\ntls-san:\n  - my-kubernetes-domain.com\n  - another-kubernetes-domain.com\n"})}),"\n",(0,r.jsx)(n.h4,{id:"2a-optional-consider-server-node-taints",children:"2a. Optional: Consider server node taints"}),"\n",(0,r.jsxs)(n.p,{children:["By default, server nodes will be schedulable and thus your workloads can get launched on them. If you wish to have a dedicated control plane where no user workloads will run, you can use taints. The ",(0,r.jsx)(n.code,{children:"node-taint"})," parameter will allow you to configure nodes with taints. Here is an example of adding a node taint to the configuration file:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'node-taint:\n  - "CriticalAddonsOnly=true:NoExecute"\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Note: The NGINX Ingress and Metrics Server addons will ",(0,r.jsx)(n.strong,{children:"not"})," be deployed when all nodes are tainted with ",(0,r.jsx)(n.code,{children:"CriticalAddonsOnly"}),". If your server nodes are so tainted, these addons will remain pending until untainted agent nodes are added to the cluster."]}),"\n",(0,r.jsx)(n.h3,{id:"3-launch-additional-server-nodes",children:"3. Launch additional server nodes"}),"\n",(0,r.jsxs)(n.p,{children:["Additional server nodes are launched much like the first, except that you must specify the ",(0,r.jsx)(n.code,{children:"server"})," and ",(0,r.jsx)(n.code,{children:"token"})," parameters so that they can successfully connect to the initial server node."]}),"\n",(0,r.jsx)(n.admonition,{title:"Matching Flags",type:"info",children:(0,r.jsxs)(n.p,{children:["It is important to match critical flags on your server nodes. For example, if you use the flag ",(0,r.jsx)(n.code,{children:"--cluster-cidr=10.200.0.0/16"})," on your first server node, but don't set it on other server nodes, the nodes will fail to join. They will print errors such as: ",(0,r.jsx)(n.code,{children:"failed to validate server configuration: critical configuration value mismatch."}),"\nSee ",(0,r.jsx)(n.a,{href:"/reference/server_config#critical-configuration-values",children:"Server Configuration"})," for more information on which flags must be set identically on server nodes."]})}),"\n",(0,r.jsx)(n.p,{children:"Example of RKE2 config file for additional server nodes:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"server: https://my-kubernetes-domain.com:9345\ntoken: my-shared-secret\ntls-san:\n  - my-kubernetes-domain.com\n  - another-kubernetes-domain.com\n\n"})}),"\n",(0,r.jsx)(n.p,{children:"As mentioned previously, you must have an odd number of server nodes in total."}),"\n",(0,r.jsxs)(n.p,{children:["If an etcd datastore is found on disk either because that node has either initialized or joined a cluster already, the argument ",(0,r.jsx)(n.code,{children:"--server"})," is ignored."]}),"\n",(0,r.jsx)(n.h3,{id:"4-confirm-cluster-is-functional",children:"4. Confirm cluster is functional"}),"\n",(0,r.jsxs)(n.p,{children:["Once you've launched the ",(0,r.jsx)(n.code,{children:"rke2 server"})," process on all server nodes, ensure that the cluster has come up properly with"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"/var/lib/rancher/rke2/bin/kubectl get nodes \\\n  --kubeconfig /etc/rancher/rke2/rke2.yaml \n"})}),"\n",(0,r.jsx)(n.p,{children:"You should see your server nodes in the Ready state."}),"\n",(0,r.jsx)(n.admonition,{type:"note",children:(0,r.jsxs)(n.p,{children:["By default, any ",(0,r.jsx)(n.code,{children:"kubectl"})," command will require root user access, unless ",(0,r.jsx)(n.code,{children:"RKE2_KUBECONFIG_MODE"})," override is provided. Read more about it in ",(0,r.jsx)(n.a,{href:"https://docs.rke2.io/cluster_access",children:"cluster access page"}),"."]})}),"\n",(0,r.jsx)(n.h3,{id:"5-optional-join-agent-nodes",children:"5. Optional: Join Agent Nodes"}),"\n",(0,r.jsx)(n.p,{children:"Because RKE2 server nodes are schedulable by default, the minimum number of nodes for an HA RKE2 server cluster is three server nodes and zero agent nodes. To add nodes designated to run your apps and services, join agent nodes to your cluster."}),"\n",(0,r.jsxs)(n.p,{children:["Joining agent nodes in an HA cluster is the same as ",(0,r.jsx)(n.a,{href:"/install/quickstart#linux-agent-worker-node-installation",children:"joining agent nodes in a single server cluster"}),". You just need to specify the URL the agent should register to and the token it should use."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"server: https://my-kubernetes-domain.com:9345\ntoken: my-shared-secret\n"})})]})}function h(e={}){const{wrapper:n}={...(0,t.a)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},1445:(e,n,s)=>{s.d(n,{Z:()=>r});const r=s.p+"assets/images/rke2-production-setup-f5158274308e4a8976ea46273d6cb5c5.svg"},1151:(e,n,s)=>{s.d(n,{Z:()=>a,a:()=>o});var r=s(7294);const t={},i=r.createContext(t);function o(e){const n=r.useContext(i);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),r.createElement(i.Provider,{value:n},e.children)}}}]);